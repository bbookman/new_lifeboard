<!DOCTYPE html>
<html>
<head>
    <title>Test Timezone Frontend Implementation</title>
</head>
<body>
    <h1>Timezone Fix Test</h1>
    
    <h2>Results:</h2>
    <div id="results">Loading...</div>
    
    <script>
        // Simulate the new getTodayYYYYMMDD function
        let cachedDate = null;
        const CACHE_DURATION_MS = 60000; // Cache for 1 minute

        async function getTodayYYYYMMDD() {
          // Check cache first
          if (cachedDate && (Date.now() - cachedDate.timestamp) < CACHE_DURATION_MS) {
            return cachedDate.date;
          }

          try {
            // Get today's date from server using configured timezone
            const response = await fetch('/calendar/api/today');
            
            if (!response.ok) {
              throw new Error(`Server responded with ${response.status}`);
            }
            
            const data = await response.json();
            
            if (!data.today) {
              throw new Error('Server response missing date');
            }
            
            // Cache the result
            cachedDate = {
              date: data.today,
              timestamp: Date.now()
            };
            
            console.log(`[TIMEZONE] Using server date: ${data.today} (timezone: ${data.timezone})`);
            return data.today;
            
          } catch (error) {
            console.warn('[TIMEZONE] Failed to get server date, falling back to browser local date:', error);
            
            // Fallback to browser's local timezone
            const fallbackDate = new Date().toISOString().split('T')[0];
            
            // Cache fallback briefly to avoid repeated failed requests
            cachedDate = {
              date: fallbackDate,
              timestamp: Date.now()
            };
            
            return fallbackDate;
          }
        }
        
        async function runTest() {
            const resultsDiv = document.getElementById('results');
            
            try {
                // Test 1: Get browser's local date
                const browserDate = new Date().toISOString().split('T')[0];
                
                // Test 2: Get server date
                const serverDate = await getTodayYYYYMMDD();
                
                // Test 3: Get server timezone info
                const response = await fetch('/calendar/api/today');
                const serverInfo = await response.json();
                
                resultsDiv.innerHTML = `
                    <p><strong>Browser Local Date:</strong> ${browserDate}</p>
                    <p><strong>Server Date (via API):</strong> ${serverDate}</p>
                    <p><strong>Server Timezone:</strong> ${serverInfo.timezone}</p>
                    <p><strong>Server Timestamp:</strong> ${serverInfo.timestamp}</p>
                    <p><strong>Test Status:</strong> ${browserDate === serverDate ? 
                        '<span style="color: orange">SAME (no timezone difference detected)</span>' : 
                        '<span style="color: green">DIFFERENT (timezone fix working!)</span>'}</p>
                `;
                
                // Test caching
                console.log('Testing cache...');
                const cachedResult = await getTodayYYYYMMDD();
                console.log('Cache test result:', cachedResult);
                
            } catch (error) {
                resultsDiv.innerHTML = `<p style="color: red"><strong>Error:</strong> ${error.message}</p>`;
            }
        }
        
        // Run test when page loads
        runTest();
    </script>
</body>
</html>